#!/bin/bash
set -e

CERT_DIR="/root/flight/www/certs"

assert_user_is_root() {
    if [[ "$( id -u )" != "0" ]] ; then
        echo "Must be root to run this script" >&2
        exit 1
    fi
}

format() {
    local columns=${COLUMNS:-`tput cols 2>&-||echo 80`}
    if [ type fmt 1>/dev/null 2>/dev/null ] ; then
        echo -e "$@" | fmt -w ${columns}
    else
        echo -e "$@"
    fi
}

create_private_key() {
    if [ -f "${CERT_DIR}"/cert.csr -a -f "${CERT_DIR}"/privkey.pem ] ; then
        echo "Using existing private key."
    else
        format "To enable HTTPs SSL certificates need to be generated.  We will" \
            "step you through generating self-signed certificates that are" \
            "valid for 1 year.\n"
        format "You will be asked to enter a passphrase and to provide details" \
            "about your organization.\n"
        format "When you are ready press enter to continue or Ctrl-C to abort.\n"

        read -s

        mkdir -p "${CERT_DIR}"
        openssl req -new > "${CERT_DIR}"/cert.csr
    fi
}

create_certs() {
    format "\nWe will now generate a public key.  You will be asked to enter" \
        "the passphrase you provided earlier.\n"
    format "When you are ready press enter to continue or Ctrl-C to abort.\n"
    read -s

    openssl rsa -in "${CERT_DIR}"/privkey.pem -out "${CERT_DIR}"/key.pem
    openssl x509 -in "${CERT_DIR}"/cert.csr \
        -out "${CERT_DIR}"/cert.pem \
        -req \
        -signkey "${CERT_DIR}"/key.pem \
        -days 365
    cat "${CERT_DIR}"/key.pem >> "${CERT_DIR}"/cert.pem
}


install_certs() {
    mkdir -p "${flight_ROOT}"/etc/www/ssl
    cp "${CERT_DIR}"/cert.pem "${flight_ROOT}"/etc/www/ssl/fullchain.pem
    cp "${CERT_DIR}"/key.pem "${flight_ROOT}"/etc/www/ssl/key.pem
}

reload_www_service() {
    "${flight_ROOT}"/bin/flight service stop www || true
    sleep 1
    "${flight_ROOT}"/bin/flight service start www || true
}

enable_https() {
    create_private_key
    create_certs
    install_certs
    mv "${flight_ROOT}"/etc/www/http.d/https.conf{.disabled,}
    reload_www_service
}

disable_https() {
    mv "${flight_ROOT}"/etc/www/http.d/https.conf{,.disabled}
    reload_www_service
}

usage() {
    local prog
    prog="flight www"
    echo "Usage: ${prog} enable-https|disable-https"
    echo "Enable or disable HTTPs support for the flight www service."
}

main() {
    assert_user_is_root

    case "$1" in
        enable-https)
            shift
            enable_https "${@}"
            ;;

        disable-https)
            shift
            disable_https "${@}"
            ;;

        --help | help)
            usage
            exit 0
            ;;

        *)
            usage
            exit 2
            ;;
    esac
}


if [[ "${BASH_SOURCE[0]}" == "${0}" ]]; then
    main "$@"
fi
