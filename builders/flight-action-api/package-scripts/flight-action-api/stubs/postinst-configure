if [ ! -f "$flight_ROOT/opt/action-api/config/nodes.yaml" ]; then
  # Create the new empty nodes config if the old one is omitted
  # NOTE: It is assumed the application is correctly configured to use
  #       the old path if it exists
  touch "$flight_ROOT/opt/action-api/etc/nodes.yaml"
fi

# Run the configuration
# Migrate the existing jwt_secret to the new config file
"$flight_ROOT"/bin/ruby <<EOF
require 'yaml'

OLD_CONFIG = "$flight_ROOT/opt/action-api/config/application.yaml"
NEW_CONFIG = "$flight_ROOT/opt/action-api/etc/action-api/shared-secret.conf"

# Attempt to load the yaml
exit unless File.exists? OLD_CONFIG
yaml = File.read OLD_CONFIG
data = YAML.load(yaml, symbolize_names: true)
exit unless data.key? :jwt_secret

# Migrate the secret to the new file
secret = data.delete :jwt_secret
FileUtils.mkdir_p File.dirname(NEW_CONFIG)
File.write NEW_CONFIG, secret

# Rewrite the old config
File.write OLD_CONFIG, YAML.dump(data)
EOF
